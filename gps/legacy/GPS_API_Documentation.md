# GPS è·¯ç·šè¿½è¹¤ API æ–‡æª”

## æ¦‚è¿°

GPS è·¯ç·šè¿½è¹¤ API æä¾›å®Œæ•´çš„ GPS ä½ç½®è³‡æ–™ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æ´è©³ç´°è»Œè·¡è¨˜éŒ„ã€è·¯ç·šçµ±è¨ˆåˆ†æã€æ­·å²è¨˜éŒ„æŸ¥è©¢å’Œè³‡æ–™ç®¡ç†ã€‚æœ¬ API ç¨ç«‹æ–¼ç”¨æˆ¶è³‡æ–™ç®¡ç†ç³»çµ±ï¼Œå°ˆé–€è™•ç†ç”¨æˆ¶ç§»å‹•è»Œè·¡çš„å®Œæ•´è¨˜éŒ„ã€‚

## ğŸ†• å¢å¼·åŠŸèƒ½

- **å®Œæ•´è»Œè·¡è¨˜éŒ„**: è¨˜éŒ„æ‰€æœ‰ GPS è³‡æ–™é»ï¼ŒåŒ…å«ä½ç½®ã€æ™‚é–“ã€æµ·æ‹”ã€ç²¾åº¦ã€é€Ÿåº¦ã€æ–¹å‘
- **è‡ªå‹•è·é›¢è¨ˆç®—**: ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—è»Œè·¡ç¸½è·é›¢
- **æ™‚é–“çµ±è¨ˆ**: è‡ªå‹•è¨ˆç®—é–‹å§‹/çµæŸæ™‚é–“å’ŒæŒçºŒæ™‚é–“
- **è©³ç´°åˆ†æ**: æä¾›è»Œè·¡çµ±è¨ˆå’Œåˆ†æè³‡æ–™
- **å¤§å®¹é‡æ”¯æ´**: æ”¯æ´æœ€å¤š 50,000 å€‹ GPS é»è¨˜éŒ„

## API ç«¯é»

### 1. ä¸Šå‚³ GPS è·¯ç·šè³‡æ–™ï¼ˆå¢å¼·ç‰ˆï¼‰

**ç«¯é»**: `POST /gps/upload`

**æè¿°**: ä¸Šå‚³ç”¨æˆ¶çš„ GPS è·¯ç·šè³‡æ–™ï¼Œæ”¯æ´å®Œæ•´è»Œè·¡è¨˜éŒ„å’Œè‡ªå‹•çµ±è¨ˆè¨ˆç®—ã€‚

**è«‹æ±‚æ ¼å¼**:
```json
{
    "user_id": "1",
    "date": "2025-07-31",
    "route": [
        {
            "lat": 25.047924,
            "lng": 121.517081,
            "ts": "2025-07-31T08:30:00.000Z",
            "altitude": 10.5,
            "accuracy": 5.0,
            "speed": 0.0,
            "heading": 0.0
        },
        {
            "lat": 25.047800,
            "lng": 121.517200,
            "ts": "2025-07-31T08:30:30.000Z",
            "altitude": 10.8,
            "accuracy": 4.5,
            "speed": 1.2,
            "heading": 45.0
        }
    ]
}
```

**åƒæ•¸èªªæ˜**:
- `user_id` (string): ç”¨æˆ¶ ID
- `date` (string): æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY-MM-DD
- `route` (array): GPS é»é™£åˆ—
  - `lat` (float): ç·¯åº¦ (-90 åˆ° 90)
  - `lng` (float): ç¶“åº¦ (-180 åˆ° 180)
  - `ts` (string): æ™‚é–“æˆ³è¨˜ï¼ŒISO 8601 æ ¼å¼
  - `altitude` (float, å¯é¸): æµ·æ‹”é«˜åº¦ï¼ˆå…¬å°ºï¼‰
  - `accuracy` (float, å¯é¸): GPS ç²¾åº¦ï¼ˆå…¬å°ºï¼‰
  - `speed` (float, å¯é¸): é€Ÿåº¦ï¼ˆå…¬å°º/ç§’ï¼‰
  - `heading` (float, å¯é¸): æ–¹å‘è§’ï¼ˆ0-360 åº¦ï¼‰

**å›æ‡‰ç¯„ä¾‹**:
```json
{
    "message": "GPS è·¯ç·šä¸Šå‚³æˆåŠŸ",
    "user_id": 1,
    "date": "2025-07-31",
    "point_count": 15,
    "total_distance": 5238.67,
    "start_time": "2025-07-31T08:30:00+00:00",
    "end_time": "2025-07-31T08:43:30+00:00"
}
```

**éŒ¯èª¤å›æ‡‰**:
- `400`: è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–é©—è­‰å¤±æ•—
- `404`: ç”¨æˆ¶ä¸å­˜åœ¨
- `500`: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤

---

### 2. ç²å–æŒ‡å®šæ—¥æœŸçš„ GPS è·¯ç·šï¼ˆå«çµ±è¨ˆï¼‰

**ç«¯é»**: `GET /gps/{user_id}/{date}`

**æè¿°**: ç²å–æŒ‡å®šç”¨æˆ¶åœ¨ç‰¹å®šæ—¥æœŸçš„ GPS è·¯ç·šè³‡æ–™å’Œå®Œæ•´çµ±è¨ˆè³‡è¨Šã€‚

**è·¯å¾‘åƒæ•¸**:
- `user_id` (integer): ç”¨æˆ¶ ID
- `date` (string): æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY-MM-DD

**å›æ‡‰ç¯„ä¾‹**:
```json
{
    "user_id": "1",
    "date": "2025-07-31",
    "route": [
        {
            "lat": 25.047924,
            "lng": 121.517081,
            "ts": "2025-07-31T08:30:00.000Z",
            "altitude": 10.5,
            "accuracy": 5.0,
            "speed": 0.0,
            "heading": 0.0
        }
    ],
    "statistics": {
        "total_points": 15,
        "total_distance": 5238.67,
        "start_time": "2025-07-31T08:30:00+00:00",
        "end_time": "2025-07-31T08:43:30+00:00",
        "duration_minutes": 13.5
    }
}
```

### 3. ç²å–è©³ç´° GPS é»è³‡æ–™

**ç«¯é»**: `GET /gps/{user_id}/{date}/points`

**æè¿°**: ç²å–æŒ‡å®šæ—¥æœŸè·¯ç·šçš„æ‰€æœ‰è©³ç´° GPS é»è³‡æ–™ã€‚

**è·¯å¾‘åƒæ•¸**:
- `user_id` (integer): ç”¨æˆ¶ ID
- `date` (string): æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY-MM-DD

**å›æ‡‰ç¯„ä¾‹**:
```json
{
    "user_id": "1",
    "date": "2025-07-31",
    "points": [
        {
            "latitude": 25.047924,
            "longitude": 121.517081,
            "timestamp": "2025-07-31T08:30:00",
            "altitude": 10.5,
            "accuracy": 5.0,
            "speed": 0.0,
            "heading": 0.0
        }
    ],
    "total_points": 15
}
```

### 4. ç²å–ç”¨æˆ¶çš„ GPS è·¯ç·šæ­·å²ï¼ˆå¢å¼·ç‰ˆï¼‰

**ç«¯é»**: `GET /gps/{user_id}/routes`

**æè¿°**: ç²å–ç”¨æˆ¶çš„ GPS è·¯ç·šæ­·å²è¨˜éŒ„ï¼ŒåŒ…å«å®Œæ•´çµ±è¨ˆè³‡è¨Šã€‚

**è·¯å¾‘åƒæ•¸**:
- `user_id` (integer): ç”¨æˆ¶ ID

**æŸ¥è©¢åƒæ•¸**:
- `limit` (integer, å¯é¸): é™åˆ¶è¿”å›çš„è¨˜éŒ„æ•¸é‡ï¼Œé è¨­ç‚º 30

**å›æ‡‰ç¯„ä¾‹**:
```json
[
    {
        "user_id": "1",
        "date": "2025-07-31",
        "point_count": 15,
        "total_distance": 5238.67,
        "start_time": "2025-07-31T08:30:00+00:00",
        "end_time": "2025-07-31T08:43:30+00:00",
        "duration_minutes": 13.5
    },
    {
        "user_id": "1",
        "date": "2025-07-30",
        "point_count": 22,
        "total_distance": 8756.23,
        "start_time": "2025-07-30T07:45:00+00:00",
        "end_time": "2025-07-30T08:15:00+00:00",
        "duration_minutes": 30.0
    }
]
```

**éŒ¯èª¤å›æ‡‰**:
- `404`: ç”¨æˆ¶ä¸å­˜åœ¨
- `500`: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤

### 5. åˆªé™¤ GPS è·¯ç·šè³‡æ–™

**ç«¯é»**: `DELETE /gps/{user_id}/{date}`

**æè¿°**: åˆªé™¤æŒ‡å®šç”¨æˆ¶åœ¨ç‰¹å®šæ—¥æœŸçš„ GPS è·¯ç·šè³‡æ–™å’Œæ‰€æœ‰ç›¸é—œé»è³‡æ–™ã€‚

**è·¯å¾‘åƒæ•¸**:
- `user_id` (integer): ç”¨æˆ¶ ID
- `date` (string): æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY-MM-DD

**å›æ‡‰ç¯„ä¾‹**:
```json
{
    "message": "GPS è³‡æ–™åˆªé™¤æˆåŠŸ"
}
```

**éŒ¯èª¤å›æ‡‰**:
- `400`: æ—¥æœŸæ ¼å¼ç„¡æ•ˆ
- `404`: ç”¨æˆ¶ä¸å­˜åœ¨æˆ–æ‰¾ä¸åˆ°æŒ‡å®šæ—¥æœŸçš„è³‡æ–™
- `500`: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤

---

## è³‡æ–™é©—è­‰è¦å‰‡

### GPS é»è³‡æ–™é©—è­‰
- **ç·¯åº¦**: å¿…é ˆåœ¨ -90 åˆ° 90 ä¹‹é–“
- **ç¶“åº¦**: å¿…é ˆåœ¨ -180 åˆ° 180 ä¹‹é–“
- **æ™‚é–“æˆ³è¨˜**: å¿…é ˆæ˜¯æœ‰æ•ˆçš„ ISO 8601 æ ¼å¼
- **æµ·æ‹”é«˜åº¦**: å¯é¸ï¼Œæ•¸å€¼å‹æ…‹ï¼ˆå…¬å°ºï¼‰
- **GPS ç²¾åº¦**: å¯é¸ï¼Œæ­£æ•¸ï¼ˆå…¬å°ºï¼‰
- **é€Ÿåº¦**: å¯é¸ï¼Œéè² æ•¸ï¼ˆå…¬å°º/ç§’ï¼‰
- **æ–¹å‘è§’**: å¯é¸ï¼Œ0-360 åº¦ä¹‹é–“

### è·¯ç·šè³‡æ–™é©—è­‰
- **è·¯ç·šé»æ•¸**: ä¸èƒ½ç‚ºç©ºï¼Œæœ€å¤šå…è¨± 50,000 å€‹é»
- **æ—¥æœŸæ ¼å¼**: å¿…é ˆæ˜¯ YYYY-MM-DD æ ¼å¼
- **ç”¨æˆ¶ ID**: å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ•¸å­—ï¼Œä¸”ç”¨æˆ¶å¿…é ˆå­˜åœ¨

---

## è»Œè·¡çµ±è¨ˆåŠŸèƒ½

### è‡ªå‹•è¨ˆç®—çµ±è¨ˆè³‡æ–™
- **ç¸½è·é›¢**: ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—å„é»é–“è·é›¢ç¸½å’Œ
- **é–‹å§‹/çµæŸæ™‚é–“**: è‡ªå‹•å¾ GPS é»æ™‚é–“æˆ³è¨˜ä¸­æå–
- **æŒçºŒæ™‚é–“**: è‡ªå‹•è¨ˆç®—è»Œè·¡ç¸½æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
- **é»æ•¸çµ±è¨ˆ**: è¨˜éŒ„è»Œè·¡ä¸­çš„ç¸½ GPS é»æ•¸

### è·é›¢è¨ˆç®—å…¬å¼
ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—åœ°çƒè¡¨é¢å…©é»é–“çš„å¤§åœ“è·é›¢ï¼š

```
a = sinÂ²(Î”Ï†/2) + cos Ï†1 â‹… cos Ï†2 â‹… sinÂ²(Î”Î»/2)
c = 2 â‹… atan2( âˆša, âˆš(1âˆ’a) )
d = R â‹… c
```

å…¶ä¸­ï¼š
- Ï† æ˜¯ç·¯åº¦
- Î» æ˜¯ç¶“åº¦
- R æ˜¯åœ°çƒåŠå¾‘ï¼ˆ6,371,000 å…¬å°ºï¼‰
- d æ˜¯å…©é»é–“è·é›¢

---

## ä½¿ç”¨ç¯„ä¾‹

### JavaScript/å‰ç«¯æ•´åˆ

```javascript
// ä¸Šå‚³å¢å¼·ç‰ˆ GPS è»Œè·¡
const routeData = [
    { 
        lat: 25.047924, 
        lng: 121.517081, 
        ts: "2025-07-31T08:30:00.000Z",
        altitude: 10.5,
        accuracy: 5.0,
        speed: 0.0,
        heading: 0.0
    },
    { 
        lat: 25.047800, 
        lng: 121.517200, 
        ts: "2025-07-31T08:30:30.000Z",
        altitude: 10.8,
        accuracy: 4.5,
        speed: 1.2,
        heading: 45.0
    }
];

try {
    const result = await fetch('/gps/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            user_id: "1",
            date: "2025-07-31",
            route: routeData
        })
    }).then(r => r.json());
    
    console.log('è»Œè·¡ä¸Šå‚³æˆåŠŸ:', result);
    console.log(`ç¸½è·é›¢: ${result.total_distance.toFixed(2)} å…¬å°º`);
    console.log(`æŒçºŒæ™‚é–“: ${result.end_time - result.start_time} åˆ†é˜`);
} catch (error) {
    console.error('ä¸Šå‚³å¤±æ•—:', error);
}

// æŸ¥è©¢è©³ç´° GPS é»è³‡æ–™
try {
    const points = await fetch('/gps/1/2025-07-31/points').then(r => r.json());
    console.log('GPS é»è³‡æ–™:', points.points);
    
    points.points.forEach((point, index) => {
        console.log(`é» ${index + 1}:`);
        console.log(`  ä½ç½®: ${point.latitude}, ${point.longitude}`);
        console.log(`  æµ·æ‹”: ${point.altitude}m, ç²¾åº¦: ${point.accuracy}m`);
        console.log(`  é€Ÿåº¦: ${point.speed}m/s, æ–¹å‘: ${point.heading}Â°`);
    });
} catch (error) {
    console.error('æŸ¥è©¢å¤±æ•—:', error);
}
```

### Python å¾Œç«¯æ•´åˆ

```python
import requests
import json

# ä¸Šå‚³ GPS è·¯ç·š
def upload_gps_route(user_id, date, route_points):
    url = "http://localhost:8000/gps/upload"
    data = {
        "user_id": user_id,
        "date": date,
        "route": route_points
    }
    
    response = requests.post(url, json=data)
    
    if response.status_code == 200:
        return response.json()
    else:
        raise Exception(f"ä¸Šå‚³å¤±æ•—: {response.text}")

# ä½¿ç”¨ç¯„ä¾‹
route_data = [
    {"lat": 25.047924, "lng": 121.517081, "ts": "2025-01-31T08:30:00.000Z"},
    {"lat": 25.046500, "lng": 121.516800, "ts": "2025-01-31T08:32:00.000Z"}
]

try:
    result = upload_gps_route("1", "2025-01-31", route_data)
    print("ä¸Šå‚³æˆåŠŸ:", result)
except Exception as e:
    print("ä¸Šå‚³å¤±æ•—:", e)
```

### cURL å‘½ä»¤ç¯„ä¾‹

```bash
# ä¸Šå‚³ GPS è·¯ç·š
curl -X POST "http://localhost:8000/gps/upload" \
     -H "Content-Type: application/json" \
     -d '{
       "user_id": "1",
       "date": "2025-01-31",
       "route": [
         {"lat": 25.047924, "lng": 121.517081, "ts": "2025-01-31T08:30:00.000Z"},
         {"lat": 25.046500, "lng": 121.516800, "ts": "2025-01-31T08:32:00.000Z"}
       ]
     }'

# æŸ¥è©¢æŒ‡å®šæ—¥æœŸè·¯ç·š
curl -X GET "http://localhost:8000/gps/1/2025-01-31"

# æŸ¥è©¢è·¯ç·šæ­·å²
curl -X GET "http://localhost:8000/gps/1/routes?limit=10"

# åˆªé™¤è·¯ç·šè³‡æ–™
curl -X DELETE "http://localhost:8000/gps/1/2025-01-31"
```

---

## è³‡æ–™åº«çµæ§‹

### GPS è·¯ç·šè¡¨ (gps_routes)
- `id`: ä¸»éµ
- `user_id`: ç”¨æˆ¶ IDï¼ˆå¤–éµï¼‰
- `date`: æ—¥æœŸ
- `route_data`: JSON æ ¼å¼çš„è·¯ç·šè³‡æ–™
- `created_at`: å»ºç«‹æ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

### GPS é»è¡¨ (gps_points)
- `id`: ä¸»éµ
- `route_id`: è·¯ç·š IDï¼ˆå¤–éµï¼‰
- `latitude`: ç·¯åº¦
- `longitude`: ç¶“åº¦
- `timestamp`: æ™‚é–“æˆ³è¨˜
- `created_at`: å»ºç«‹æ™‚é–“

---

## æ•ˆèƒ½è€ƒé‡

- **è·¯ç·šé»æ•¸é™åˆ¶**: å–®æ¬¡ä¸Šå‚³æœ€å¤š 10,000 å€‹ GPS é»
- **æŸ¥è©¢æ­·å²é™åˆ¶**: é è¨­è¿”å›æœ€è¿‘ 30 æ¢è¨˜éŒ„ï¼Œå¯èª¿æ•´
- **è³‡æ–™ç´¢å¼•**: åœ¨ user_id å’Œ date æ¬„ä½ä¸Šå»ºç«‹ç´¢å¼•ä»¥æå‡æŸ¥è©¢æ•ˆèƒ½
- **JSON å„²å­˜**: è·¯ç·šè³‡æ–™ä»¥ JSON æ ¼å¼å„²å­˜ï¼Œé©åˆè¤‡é›œçš„è·¯ç·šçµæ§‹

---

## å®‰å…¨æ€§

- **ç”¨æˆ¶é©—è­‰**: æ‰€æœ‰æ“ä½œéƒ½æœƒé©—è­‰ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
- **è³‡æ–™é©—è­‰**: åš´æ ¼çš„ GPS åº§æ¨™å’Œæ—¥æœŸæ ¼å¼é©—è­‰
- **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯å’Œç‹€æ…‹ç¢¼å›æ‡‰
- **äº¤æ˜“ä¿è­·**: è³‡æ–™åº«æ“ä½œä½¿ç”¨äº¤æ˜“ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

---

## æœªä¾†æ“´å±•

å¯èƒ½çš„åŠŸèƒ½æ“´å±•ï¼š
1. **è·¯ç·šåˆ†æ**: è¨ˆç®—è·é›¢ã€é€Ÿåº¦ã€åœç•™æ™‚é–“ç­‰çµ±è¨ˆè³‡æ–™
2. **è·¯ç·šå…±äº«**: å…è¨±ç”¨æˆ¶åˆ†äº«è·¯ç·šçµ¦å…¶ä»–ç”¨æˆ¶
3. **è·¯ç·šæœå°‹**: æŒ‰åœ°ç†å€åŸŸæˆ–è·¯ç·šç‰¹å¾µæœå°‹
4. **æ‰¹æ¬¡æ“ä½œ**: æ”¯æ´æ‰¹æ¬¡ä¸Šå‚³å’Œåˆªé™¤æ“ä½œ
5. **å³æ™‚è¿½è¹¤**: WebSocket æ”¯æ´å³æ™‚ä½ç½®æ›´æ–°
